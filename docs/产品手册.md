<a id="index"></a>
# oss_pipe 使用手册
- [产品介绍](#product_intro)
- [Getting Started](#getting_start)
- [任务描述参考手册](#task_yml)
- [命令参考手册](#command)
- [最佳实践](#best_practices)
- [错误处理](#Troubleshooting)

<a id="product_intro"></a>
## 产品介绍
oss_pipe 是 rust 编写的文件迁移工具，旨在支撑大规模的文件迁移场景。相比 java 或 golang 构建的同类型产品，借助 rust 语言的优势，oss_pipe 具备无 GC、高并发、部署便利、OOM 风险低等优势。
目前支持对象存储提供商：
JD
JRSS
ALI
S3
HUAWEI
COS
MINIO

### 主要功能

#### transfer 
文件迁移，包括 oss 间文件迁移和本地到 oss 的文件迁移

* 主要功能
  * 全量迁移
  * 存量迁移
  * 增量迁移
  * 断点续传
  * 大文件拆分上传
  * 正则表达式过滤
  * 线程数与上传快大小组合控制带宽

* 存储适配及支持列表
  * 京东云对象存储
  * 阿里云对象存储
  * 腾讯云对象存储
  * 华为云对象存储
  * AWS 对象存储
  * Minio
  * 本地

#### compare 
文件校验，检查源文件与迁移完成后目标文件的差异

* 主要功能
  * 存在性校验
  * 文件长度校验
  * meta 数据校验
  * 过期时间校验
  * 全字节流校验

[返回目录](#index)

<a id="getting_start"></a>
## Getting Stated

### 依赖安装

- ubuntu 22 x86_64
```shell
apt update \
&& apt install openssl -y \
&& apt install libssl-dev \
&& apt install -y pkg-config
```

- centos 8 x86_64
```shell
yum install git gcc -y
```

- Rocky 9 x86_64
```shell
yum install git gcc -y
```

- OpenEuler 22.03 x86_64
```shell
yum install git gcc -y
```

- OpenCloudOS 8.6 x86_64
```shell
yum install git gcc -y
```

- UOS v20 x86_64
```shell
yum install git gcc -y
```

- ubuntu 20 arm
```shell
apt update \
&& apt install openssl -y \
&& apt install libssl-dev \
&& apt install -y pkg-config
```

- OpenEuler 22.03 arm
```shell
yum install git gcc -y
```

### 基本使用

oss_pipe 支持命令执行模式和交互式执行模式。
您可以通过 oss_pipe [subcommand] 执行执行任务，比如

```shell
oss_pipe parameters provider
```

也可以通过 oss_pipe -i 命里进入交互模式。交互模式支持按 'tab' 键进行子命令提示。

### 定义任务

通过 oss_pipe template 命令生成模板

```shell
oss_pipe template transfer oss2oss /tmp/transfer.yml
```

transfer.yml 文件内容

```yml
type: transfer
task_id: '7350341491509825537'
name: transfer_oss2oss
source:
  provider: ALI
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://oss-cn-beijing.aliyuncs.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
target:
  provider: JD
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://s3.cn-north-1.jdcloud-oss.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
attributes:
  objects_transfer_batch: 64
  task_parallelism: 4
  meta_dir: /tmp/meta_dir
  target_exists_skip: false
  start_from_checkpoint: false
  large_file_size: 64m
  multi_part_chunk_size: 8m
  multi_part_chunks_per_batch: 16
  multi_part_parallelism: 8
  multi_part_max_parallelism: 12
  exclude:
  - \b[\w-]*(https?|ftp|file):\/\/\S+
  - ^test\/t1\/.*
  include:
  - ^test\/t2\/.*
  transfer_type: stock
  last_modify_filter:
    filter_type: Greater
    timestamp: 1752457974
  objects_list_batch: 512
  objects_list_file_max_line: 1000000
  objects_list_files: null
  increment_mode:
    interval: 3600
```

修改 access_key_id secret_access_key 等参数，适配自己的任务。template 命令按照任务类型创建模版。parameters 支持参数查询，包括支持的 provider 以及 任务类型
更多配置详情请参考[]()

以本地上传为例，任务描述 yml 文件如下：
transfer_local2oss.yml
```yml
type: transfer
name: transfer_local2oss
source: /tmp
target:
  provider: JD
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://s3.cn-north-1.jdcloud-oss.com
  region: cn-north-1
  bucket: bucket_name
attributes:
  objects_transfer_batch: 64
  task_parallelism: 2
  meta_dir: /tmp/meta_dir
  target_exists_skip: false
  start_from_checkpoint: false
  large_file_size: 64m
  multi_part_chunk_size: 8m
  multi_part_chunks_per_batch: 16
  multi_part_parallelism: 8
  multi_part_max_parallelism: 12
  transfer_type: stock
```

### 执行任务

osstask 子命令用于执行任务

```shell
oss_pipe task exec filepath/task.yml
```

任务配置请参考[任务配置手册](#task_yml)

命令请参考[命令手册](#command)

[返回目录](#index)

<a id="task_yml"></a>
## 任务描述参考手册

oss_pipe 通过 yml 格式描述需要执行的任务

### yaml 描述文件基本结构

#### 描述文件概述
任务描述主要分为三个主要部分
- type、task_id、name，用于定义任务的基本信息，type 为类型描述，目前支持 transfer 和 compare 两类任务。
- source、targe 用于描述源于目标存储信息，可以是本地存储（目录）或对象存储
- attributes，用于描述任务属性，包括并发数、过滤器等信息

基本属性描述
- type: 描述任务类型，目前支持 transfer 和 compare 两类任务
- task_id：描述任务唯一 id 以及任务名称，
- name：任务名称，使用者自定义
- source: 描述远端存储类别
- target: 描述目标端存储类别
- attributes: 描述任务属性



#### transfer yaml
```
type: transfer
task_id: '7322221674433220609'
name: transfer_oss2oss
source:
  provider: ALI
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://oss-cn-beijing.aliyuncs.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
target:
  provider: JD
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://s3.cn-north-1.jdcloud-oss.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
attributes:
  objects_per_batch: 64
  task_parallelism: 4
  meta_dir: /tmp/meta_dir
  target_exists_skip: false
  start_from_checkpoint: false
  large_file_size: 64m
  multi_part_chunk_size: 8m
  multi_part_chunks_per_batch: 16
  multi_part_parallelism: 8
  multi_part_max_parallelism: 12
  exclude:
  - \b[\w-]*(https?|ftp|file):\/\/\S+
  - test/t4/*
  include:
  - test/t1/*
  - test/t2/*
  transfer_type: stock
  last_modify_filter:
    filter_type: Greater
    timestamp: 1745753687
  objects_list_files_max_line: 1000000
```


#### transfer yml 参数详解

<table>
    <tr>
	  <td >配置项</td>
	  <td>字段属性</td>
	  <td>必填</td>  
      <td>描述</td>
      <td>示例</td>   
	</tr >
    <tr>
	   <td> type </td>
	   <td>String</td>
       <td>是</td>
       <td>任务类型，transfer 或 compare，详细执行类型通过：oss_pipe  parameters task_type 查看</td>
       <td>type: transfer/compare</td>
	</tr>
     <tr>
	   <td>task_id</td>
	   <td>String</td>
       <td>否</td>
       <td>任务 id，为空时由系统生成</td>
       <td>task_id: '7219552894540976129'</td>
	</tr>
    <tr>
	   <td>name</td>
	   <td>String</td>
       <td>否</td>
       <td>任务名称，为空时系统生成默认名称</td>
       <td>name: transfer_oss2oss</td>
	</tr>
    <tr>
	   <td>source</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为本地目录时，指定本地目录</td>
       <td>source: /tmp/source_files</td>
	</tr>
    <tr>
	   <td>source.provider</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，描述对象存储提供商。值为 JD/JRSS/ALI/AWS/HUAWEI/COS/MINIO，支持的对象存储提供商通过 oss_pipe parameters provider 查询</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;provider: AWS</td>
	</tr>
    <tr>
	   <td>source.access_key_id</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 access_key。</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;access_key_id: xxxx</td>
	</tr>
    <tr>
	   <td>source.secret_access_key</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 secret key</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; secret_access_key: xxxx</td>
	</tr>
    <tr>
	   <td>source.endpoint</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 endpoint</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;endpoint: http://oss-cn-beijing.aliyuncs.com</td>
	</tr>
    <tr>
	   <td>source.region</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 region</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;region: cn-north-1</td>
	</tr>
    <tr>
	   <td>source.bucket</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 bucket</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;bucket: bucket_name</td>
	</tr>
    <tr>
	   <td>source.prefix</td>
	   <td>String</td>
       <td>否</td>
       <td>当源为对象存储时，指定 prefix 时，只对该 prefix 下的对象进行操作</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;prefix: source/test/prefix/</td>
	</tr>
      <tr>
	   <td>source.request_style</td>
	   <td>String</td>
       <td>否</td>
       <td>对象存储 url 编码格式，取值：PathStyle/VirtualHostedStyle，默认 VirtualHostedStyle</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;request_style: VirtualHostedStyle</td>
	</tr>
    <tr>
	   <td>target</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为本地目录时，指定本地目录</td>
       <td>target: /tmp/target_files</td>
	</tr>
    <tr>
	   <td>target.provider</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，描述对象存储提供商。值为 JD/JRSS/ALI/AWS/HUAWEI/COS/MINIO，支持的对象存储提供商通过 oss_pipe parameters provider 查询</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;provider: AWS</td>
	</tr>
    <tr>
	   <td>target.access_key_id</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，指定对象存储的 access_key。</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;access_key_id: xxxx</td>
	</tr>
    <tr>
	   <td>target.secret_access_key</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 secret key</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; secret_access_key: xxxx</td>
	</tr>
    <tr>
	   <td>target.endpoint</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 endpoint</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;endpoint: http://oss-cn-beijing.aliyuncs.com</td>
	</tr>
    <tr>
	   <td>target.region</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 region</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;region: cn-north-1</td>
	</tr>
    <tr>
	   <td>target.bucket</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 bucket</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;bucket: bucket_name</td>
	</tr>
    <tr>
	   <td>target.prefix</td>
	   <td>String</td>
       <td>否</td>
       <td>当目标为对象存储时，指定 prefix 时，目标添加 prefix，例如源 key 为 a，指定 prefix 为 p/时，a 在目标的 key 为 p/a</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;prefix: target/prefix/</td>
	</tr>
    <tr>
	   <td>target.request_style</td>
	   <td>String</td>
       <td>否</td>
       <td>对象存储 url 编码格式，取值：PathStyle/VirtualHostedStyle，默认 VirtualHostedStyle</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;request_style: VirtualHostedStyle</td>
	</tr>
    <tr>
	   <td>attributes.objects_transfer_batch</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，每批次执行的对象数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_transfer_batch: 100</td>
	</tr>
    <tr>
	   <td>attributes.task_parallelism</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，任务并行度，既同时执行任务批次的数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;task_parallelism: 16</td>
	</tr>
    <tr>
	   <td>attributes.objects_list_batch</td>
	   <td>usize</td>
       <td>否</td>
       <td>任务属性，对象列表批次，每批次写入列表文件的数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_batch: 1000</td>
	</tr>
    <tr>
	   <td>attributes.meta_dir</td>
	   <td>String</td>
       <td>否</td>
       <td>任务属性，元数据存储位置，默认路径/tmp/meta_dir</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;meta_dir: /root/meta_dir</td>
	</tr>
    <tr>
	   <td>attributes.target_exists_skip</td>
	   <td>bool</td>
       <td>否</td>
       <td>任务属性，当 target 存在同名对象时不传送对象，默认值为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;target_exists_skip: false</td>
	</tr>
    <tr>
	   <td>attributes.start_from_checkpoint</td>
	   <td>bool</td>
       <td>否</td>
       <td>任务属性，是否从 checkpoint 开始执行任务，用于任务中断后接续执行，默认值 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;start_from_checkpoint: true</td>
	</tr>
    <tr>
	   <td>attributes.large_file_size</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，超过该参数设置尺寸的文件，文件切片传输</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;large_file_size: 50M</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_chunk_size</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，对象分片尺寸</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_chunk_size: 10m</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_chunks_per_batch</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，每批执行的分片数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; multi_part_chunks_per_batch: 20</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_parallelism</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，分片批次执行的并行度</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_parallelism: 8</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_max_parallelism</td>
	   <td>usize</td>
       <td>否</td>
       <td>任务属性，分片上传的最大并行度</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_max_parallelism: 12</td>
	</tr>
    <tr>
	   <td>attributes.exclude</td>
	   <td>list</td>
       <td>否</td>
       <td>任务属性，配置排除对象的正则表达式列表，符合列表的对象将不被处理</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;oexclude: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t3/* <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t4/*</td>
	</tr>
    <tr>
	   <td>attributes.include</td>
	   <td>list</td>
       <td>是</td>
       <td>任务属性，配置正则表达式列表，程序只处理符合列表的对象</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;include: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t3/* <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t4/*</td></td>
	</tr>
    <tr>
	   <td>attributes.transfer_type</td>
	   <td>String</td>
       <td>是</td>
       <td>任务属性，传输类型 stock/full,目前支持存量和全量模式</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;transfer_type: stock/full</td>
	</tr>
    <tr>
	   <td>attributes.last_modify_filter</td>
	   <td>usize</td>
       <td>否</td>
       <td>任务属性，根据需要筛选符合实际戳条件的对象进行传输</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;last_modify_filter: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_type: Greater/Less <br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timestamp: 1721284711</td>
	</tr>
        <tr>
	   <td>attributes.objects_list_batch</td>
	   <td>i32</td>
       <td>否</td>
       <td>获取传输列表时，每批次获取对象的数量，默认值 512，当源为对象存储时最大 1000</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_batch: 512</td>
	</tr>
    <tr>
	   <td>attributes.objects_list_file_max_line</td>
	   <td>i32</td>
       <td>否</td>
       <td>列表文件容纳的最大行数，超过自动填充下一个列表文件</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_file_max_line: 100000</td>
	</tr>
    <tr>
	   <td>attributes.objects_list_files</td>
	   <td>list</td>
       <td>否</td>
       <td>任务属性，手动指定列表文件</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_files: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- /path/to/list1.txt <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- /path/to/list2.txt</td>
	</tr>
    <tr>
	   <td>attributes.increment_mode</td>
	   <td>String</td>
       <td>否</td>
       <td>任务属性，增量模式：scan 或 notify</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;increment_mode: scan</td>
	</tr>    
</table>

### compare yaml
```
type: compare
task_id: '7350354445546426369'
name: default_name
source:
  provider: JD
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://s3.cn-north-1.jdcloud-oss.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
target:
  provider: JD
  access_key_id: access_key_id
  secret_access_key: secret_access_key
  endpoint: http://s3.cn-north-1.jdcloud-oss.com
  region: cn-north-1
  bucket: bucket_name
  prefix: test/samples/
  request_style: VirtualHostedStyle
check_option:
  check_content_length: true
  check_expires: false
  check_content: false
  check_meta_data: false
attributes:
  objects_per_batch: 64
  task_parallelism: 16
  meta_dir: /tmp/meta_dir
  start_from_checkpoint: false
  large_file_size: 64m
  multi_part_chunk: 8m
  multi_part_max_parallelism: 12
  exclude: null
  include: null
  exprirs_diff_scope: 10
  last_modify_filter: null
  objects_list_batch: 512
  objects_list_files_max_line: 1000000
```

#### compare yml 参数详解

<table>
    <tr>
	  <td >配置项</td>
	  <td>字段属性</td>
	  <td>必填</td>  
      <td>描述</td>
      <td>示例</td>   
	</tr >
    <tr>
	   <td> type </td>
	   <td>String</td>
       <td>是</td>
       <td>任务类型，transfer 或 compare，详细执行类型通过：oss_pipe  parameters task_type 查看</td>
       <td>type: transfer/compare</td>
	</tr>
     <tr>
	   <td>task_id</td>
	   <td>String</td>
       <td>否</td>
       <td>任务 id，为空时由系统生成</td>
       <td>task_id: '7219552894540976129'</td>
	</tr>
    <tr>
	   <td>name</td>
	   <td>String</td>
       <td>否</td>
       <td>任务名称，为空时系统生成默认名称</td>
       <td>name: transfer_oss2oss</td>
	</tr>
    <tr>
	   <td>source</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为本地目录时，指定本地目录</td>
       <td>source: /tmp/source_files</td>
	</tr>
    <tr>
	   <td>source.provider</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，描述对象存储提供商。值为 JD/JRSS/ALI/AWS/HUAWEI/COS/MINIO，支持的对象存储提供商通过 oss_pipe parameters provider 查询</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;provider: AWS</td>
	</tr>
    <tr>
	   <td>source.access_key_id</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 access_key。</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;access_key_id: xxxx</td>
	</tr>
    <tr>
	   <td>source.secret_access_key</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 secret key</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; secret_access_key: xxxx</td>
	</tr>
    <tr>
	   <td>source.endpoint</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 endpoint</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;endpoint: http://oss-cn-beijing.aliyuncs.com</td>
	</tr>
    <tr>
	   <td>source.region</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 region</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;region: cn-north-1</td>
	</tr>
    <tr>
	   <td>source.bucket</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，对象存储 bucket</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;bucket: bucket_name</td>
	</tr>
    <tr>
	   <td>source.prefix</td>
	   <td>String</td>
       <td>否</td>
       <td>当源为对象存储时，指定 prefix 时，只对该 prefix 下的对象进行操作</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;prefix: source/test/prefix/</td>
	</tr>
      <tr>
	   <td>source.request_style</td>
	   <td>String</td>
       <td>否</td>
       <td>对象存储 url 编码格式，取值：PathStyle/VirtualHostedStyle，默认 VirtualHostedStyle</td>
       <td>source:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;request_style: VirtualHostedStyle</td>
	</tr>
    <tr>
	   <td>target</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为本地目录时，指定本地目录</td>
       <td>target: /tmp/target_files</td>
	</tr>
    <tr>
	   <td>target.provider</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，描述对象存储提供商。值为 JD/JRSS/ALI/AWS/HUAWEI/COS/MINIO，支持的对象存储提供商通过 oss_pipe parameters provider 查询</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;provider: AWS</td>
	</tr>
    <tr>
	   <td>target.access_key_id</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，指定对象存储的 access_key。</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;access_key_id: xxxx</td>
	</tr>
    <tr>
	   <td>target.secret_access_key</td>
	   <td>String</td>
       <td>是</td>
       <td>当源为对象存储时，指定对象存储的 secret key</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; secret_access_key: xxxx</td>
	</tr>
    <tr>
	   <td>target.endpoint</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 endpoint</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;endpoint: http://oss-cn-beijing.aliyuncs.com</td>
	</tr>
    <tr>
	   <td>target.region</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 region</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;region: cn-north-1</td>
	</tr>
    <tr>
	   <td>target.bucket</td>
	   <td>String</td>
       <td>是</td>
       <td>当目标为对象存储时，对象存储 bucket</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;bucket: bucket_name</td>
	</tr>
    <tr>
	   <td>target.prefix</td>
	   <td>String</td>
       <td>否</td>
       <td>当目标为对象存储时，指定 prefix 时，目标添加 prefix，例如源 key 为 a，指定 prefix 为 p/时，a 在目标的 key 为 p/a</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;prefix: target/prefix/</td>
	</tr>
    <tr>
	   <td>target.request_style</td>
	   <td>String</td>
       <td>否</td>
       <td>对象存储 url 编码格式，取值：PathStyle/VirtualHostedStyle，默认 VirtualHostedStyle</td>
       <td>target:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;request_style: VirtualHostedStyle</td>
	</tr>
    <tr>
	   <td>check_option.check_content_length</td>
	   <td>usize</td>
       <td>否</td>
       <td>校验属性，是否校验内容长度，默认为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;check_content_length: false</td>
	</tr>
    <tr>
    	<td>check_option.check_expire</td>
	   <td>usize</td>
       <td>否</td>
       <td>校验属性，是否校验过期时间，当源和目标均为对象存储时起作用，默认为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;check_expire: false</td>
	</tr>
    <tr>
    	<td>check_option.check_meta_data</td>
	   <td>usize</td>
       <td>否</td>
       <td>是否校验 meta data，当源和目标均为对象存储时生效，默认为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;check_meta_data: false</td>
	</tr>   
    <tr>
    	<td>check_option.check_content</td>
	   <td>usize</td>
       <td>否</td>
       <td>是否校验文件内容，开启该配置会对文件内容按字节进行校验，流量消耗大，慎重开启，默认为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;check_content: false</td>
	</tr>     
    <tr>
	   <td>attributes.objects_per_batch</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，每批次执行的对象数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_per_batch: 100</td>
	</tr>
    <tr>
	   <td>attributes.task_parallelism</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，任务并行度，既同时执行任务批次的数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;task_parallelism: 16</td>
	</tr>
    <tr>
	   <td>attributes.objects_list_batch</td>
	   <td>usize</td>
       <td>否</td>
       <td>任务属性，对象列表批次，每批次写入列表文件的数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_batch: 1000</td>
	</tr>
    <tr>
	   <td>attributes.meta_dir</td>
	   <td>String</td>
       <td>否</td>
       <td>任务属性，元数据存储位置，默认路径/tmp/meta_dir</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;meta_dir: /root/meta_dir</td>
	</tr>
    <tr>
	   <td>attributes.target_exists_skip</td>
	   <td>bool</td>
       <td>否</td>
       <td>任务属性，当 target 存在同名对象时不传送对象，默认值为 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;target_exists_skip: false</td>
	</tr>
    <tr>
	   <td>attributes.start_from_checkpoint</td>
	   <td>bool</td>
       <td>否</td>
       <td>任务属性，是否从 checkpoint 开始执行任务，用于任务中断后接续执行，默认值 false</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;start_from_checkpoint: true</td>
	</tr>
    <tr>
	   <td>attributes.large_file_size</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，超过该参数设置尺寸的文件，文件切片传输</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;large_file_size: 50M</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_chunk_size</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，对象分片尺寸</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_chunk_size: 10m</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_chunks_per_batch</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，每批执行的分片数量</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp; multi_part_chunks_per_batch: 20</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_parallelism</td>
	   <td>usize</td>
       <td>是</td>
       <td>任务属性，分片批次执行的并行度</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_parallelism: 8</td>
	</tr>
    <tr>
	   <td>attributes.multi_part_max_parallelism</td>
	   <td>usize</td>
       <td>否</td>
       <td>任务属性，分片上传的最大并行度</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;multi_part_max_parallelism: 12</td>
	</tr>
    <tr>
	   <td>attributes.exclude</td>
	   <td>list</td>
       <td>否</td>
       <td>任务属性，配置排除对象的正则表达式列表，符合列表的对象将不被处理</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;oexclude: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t3/* <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t4/*</td>
	</tr>
    <tr>
	   <td>attributes.include</td>
	   <td>list</td>
       <td>是</td>
       <td>任务属性，配置正则表达式列表，程序只处理符合列表的对象</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;include: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t3/* <br>
        &nbsp;&nbsp;&nbsp;&nbsp;- test/t4/*</td></td>
	</tr>
    	</tr>
        <tr>
	   <td>attributes.exprirs_diff_scope</td>
	   <td>i32</td>
       <td>否</td>
       <td>当校验过期时间时由于服务器间的时间差异需要一定冗余，既相差在一定时间内既为校验成功，默认相差 10 秒以内</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;exprirs_diff_scope: 10</td>
	</tr>
	</tr>
    	</tr>
        <tr>
	   <td>attributes.objects_list_batch</td>
	   <td>i32</td>
       <td>否</td>
       <td>获取传输列表时，每批次获取对象的数量，默认值 512，当源为对象存储时最大 1000</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_batch: 512</td>
	</tr>
    <tr>
	   <td>attributes.objects_list_file_max_line</td>
	   <td>i32</td>
       <td>否</td>
       <td>列表文件容纳的最大行数，超过自动填充下一个列表文件</td>
       <td>attributes:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;objects_list_file_max_line: 100000</td>
	</tr>       
</table>

[返回目录](#index)

<a id="command"></a>
## 命令参考手册

oss_pipe 同时支持命令行模式和交互模式 oss_pipe -i 进入交互模式。交互模式使用'tab'键进行子命令提示。
可以执行 tree 命令列出命令及子命令的层次关系
```
oss_pipe
├── task
│   ├── analyze
│   ├── exec
│   ├── list_objects
│   └── list_obj_to_multi
├── template
│   ├── transfer
│   │   ├── oss2oss
│   │   ├── oss2local
│   │   ├── local2oss
│   │   └── local2local
│   ├── delete_bucket
│   └── compare
│       ├── oss2oss
│       ├── oss2local
│       ├── local2oss
│       └── local2local
├── parameters
│   ├── provider
│   └── task_type
├── config
│   ├── show
│   │   ├── info
│   │   └── all
│   └── gendefault
├── gen_file
├── gen_files
├── exit
└── tree
```

### 命令详解

#### task
task 子命令用于执行任务相关操作
<table>
	<tr>
	    <th colspan="4">task</th>
	</tr >
    <tr>
	  <td >命令</td>
	  <td>描述  </td>
	  <td>参数</td>  
      <td>示例</td>  
	</tr >
    <tr>
	   <td>exec</td>
	   <td>按任务描述文件执行任务</td>
       <td>&lt;taskfile&gt;</td>
       <td>oss_pipe task exec task.yml</td>
	</tr>
    <tr>
	   <td>analyze</td>
	   <td>分析远端文件尺寸占比 </td>
       <td>&lt;taskfile&gt;</td>
       <td>oss_pipe task analyze task.yml</td>
	</tr>    
</table>


#### template
template 子命令用户生成
<table>
	<tr>
	    <th colspan="4">template</th>
	</tr >
	<tr>
	    <td >命令</td>
	    <td>子命令 </td>
	    <td>描述</td>  
        <td>示例</td>  
	</tr >
	<tr >
	    <td rowspan="4">transfer</td>
        <td >oss2oss</td>
        <td >用于生成文件传输类，对象存储到对象存储场景模版</td>
        <td >oss_pipe template transfer oss2oss</td>    
	</tr>
  	<tr>
	    <td>oss2local</td>
	    <td>用于生成文件传输类，对象存储到本地存储场景模版</td>
       <td>oss_pipe template transfer oss2local</td>
	</tr>
  	<tr>
	    <td>local2oss</td>
	    <td>用于生成文件传输类，本地存储到对象存储场景模版</td>
       <td>oss_pipe template transfer local2oss</td>
	</tr>
    <tr>
	    <td>local2local</td>
	    <td>用于生成文件传输类，本地存储到本地存储场景模版</td>
       <td>oss_pipe template transfer local2local</td>
	</tr>
	<tr>
	    <td rowspan="4">compare</td>
	    <td >oss2oss</td>
        <td >用于生成校验模版，对象存储到对象存储场景模版</td>
        <td >oss_pipe template transfer oss2oss</td>
	</tr>
	  	<tr>
	    <td>oss2local</td>
	    <td>用于生成校验模版，对象存储到本地存储场景模版</td>
       <td>oss_pipe template transfer oss2local</td>
	</tr>
  	<tr>
	    <td>local2oss</td>
	    <td>用于生成校验模版，本地存储到对象存储场景模版</td>
       <td>oss_pipe template transfer local2oss</td>
	</tr>
    <tr>
	    <td>local2local</td>
	    <td>用于生成校验模版，本地存储到本地存储场景模版</td>
       <td>oss_pipe template transfer local2local</td>
	</tr>
</table>

#### parameters
parameters 展示 oss_pipe 支持的对象存储供应商，任务类型等信息
<table>
	<tr>
	    <th colspan="3">parameters</th>
	</tr>
    <tr>
	  <td >命令</td>
	  <td>描述  </td>
      <td>示例</td>  
	</tr >
    <tr>
	   <td>provider</td>
	   <td>显示支持的对象存储提供方</td>
       <td>oss_pipe parameters provider</td>
	</tr>
    <tr>
	   <td>task_type</td>
	   <td>显示任务类型 </td>
       <td>oss_pipe parameters task_type</td>
	</tr>    
</table>

#### gen_file
gen_file 命令，用于生成文件
<table>
	<tr>
	    <th colspan="4">gen_file</th>
	</tr >
    <tr>
	  <td>命令</td>
	  <td>参数</td>
      <td>描述</td>  
      <td>示例</td>  
	</tr >
    <tr>
	   <td rawspan="3">gen_file</td>
       <td>&lt;file_size&gt;</td>
	   <td>文件大小</td>
       <td rawspan="3">oss_pipe gen_file 10m 1m /root/testfile</td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;chunk_size&gt;</td> 
       <td>生成文件时每个写入块大小</td>
       <td></td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;file_name&gt;</td> 
       <td>文件路径</td>
       <td></td>
	</tr>     
</table>


#### gen_files
gen_files 命令，用于批量生成文件。
<table>
	<tr>
	    <th colspan="4">gen_files</th>
	</tr >
    <tr>
	  <td>命令</td>
	  <td>参数</td>
      <td>描述</td>  
      <td>示例</td>  
	</tr >
    <tr>
	   <td rawspan="3">gen_files</td>
       <td>&lt;dir&gt;</td>
	   <td>生成批量文件的目录</td>
       <td rawspan="3">oss_pipe gen_files /tmp 3 10m 1m 10</td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;file_prefix_len&gt;</td> 
       <td>文件前缀长度</td>
       <td></td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;file_size&gt;</td> 
       <td>文件尺寸</td>
       <td></td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;chunk_size&gt;</td> 
       <td>生成文件时每块尺寸</td>
       <td></td>
	</tr>
    <tr>    	
       <td></td>	 
       <td>&lt;file_quantity&gt;</td> 
       <td>生成文件数量</td>
       <td></td>
	</tr>      
</table>

#### tree
tree 命令，显示所有命令及子命令的树形关系图

#### exit
exit 命令，再交互模式下退出程序

[返回目录](#index)

<a id="best_practices"></a>
## 最佳实践

### 全量迁移

- 任务编排

  通过命令  parameters provider 查看 支持的 oss 供应商
   
  
  编写任务描述文件

  ```yml
  type: transfer
  name: transfer_oss2oss
  source:
    provider: JD
    access_key_id: access_key_id
    secret_access_key: secret_access_key
    endpoint: http://oss-cn-beijing.aliyuncs.com
    region: cn-north-1
    bucket: source_bucket_name
  target:
    provider: JD
    access_key_id: access_key_id
    secret_access_key: secret_access_key
    endpoint: http://s3.cn-north-1.jdcloud-oss.com
    region: cn-north-1
    bucket: target_bucket_name
  attributes:
    objects_transfer_batch: 64
    task_parallelism: 2
    meta_dir: /tmp/meta_dir
    target_exists_skip: false
    start_from_checkpoint: false
    large_file_size: 64m
    multi_part_chunk_size: 8m
    multi_part_chunks_per_batch: 16
    multi_part_parallelism: 8
    multi_part_max_parallelism: 12
    transfer_type: stock
  ```

- 任务源分析
  
  通过命令 oss_pipe task analyze {file.yml} 分析任务源，得到分析结果
  ```
  .--------------------------------.
  | size_range | objects | percent |
  | 0-1M       | 1       | 0.07    |
  | 300-500M   | 3       | 0.21    |
  | 1-10M      | 10      | 0.71    |
  '--------------------------------'
  ```
  分析结构会给出源端文件大小及数量的分布，可以根据这些信息调整 task_parallelism、objects_per_batch、multi_part_chunk_size、multi_part_chunks_per_batch、multi_part_parallelism 等参数。通常小文件占比越少 objects_per_batch 越大，task_parallelism 配置最好设置在 cpu 核数的 3 倍以内，multi_part_parallelism 通常与 cpu 核数相当，若迁移的大文件较多可适当增加，原则上保持在 cpu 核数的 3 倍以内。

- 执行迁移任务
  通过 oss_pipe task exec {file.yml} 命令 

### 对象过滤
在生产实践中，存在需要对源文件进行过滤的场景。oss_pipe 提供一下对象过滤的手段。

- prefix 过滤
  当远端为对象存储配置
  ```
  source:
    prefix: xxx/xxx/
  ```
  程序只对于 prefix 相符的源端对象进行操作。

- 正则表达式过滤
  ```
  attributes:
    exclude:
    - test/t3/*
    - test/t4/*
    include:
    - test/t1/*
    - test/t2/*
  ```
  任务首先通过 exclude 条件进行过滤，排除符合 exclude 条件的对象；在 exclude 过滤的结果集中筛选符合 include 条件的对象。

- 时间戳过滤
  ```
  attributes:
    last_modify_filter:
        filter_type: Greater
        timestamp: 1721789609

  ```
  oss_pipe 可以通过文件最后修改的时间戳作为条件进行过滤。可以通过定义 filter_type，选择 Greater(大于等于) 或 Less(小于等于) 时间戳来定义过滤条件

### 利用回源功能迁移
oss_pipe 本身支持增量数据迁移，但在 bucket 数据量过于庞大时，轮训时间较长。这时可以通过对象存储本身的回源功能实现迁移动作。
步骤如下：
- 进行存量迁移
- 配置目标端回源 (详细步骤参考对象存储提供商文档)
- 切换应用到目标端
- 通过时间戳过滤迁移远端增量部分，时间戳设为首次迁移的起始时间 v

### 异常中断处理
在文件迁移过程中，经常遇到由于网络或其他原因任务中断的情况。可以通过配置一下参数后重新启动任务进行任务续接。
```
attributes:
  start_from_checkpoint: ture
```
当 start_from_checkpoint 为 true。当任务处于存量阶段时启动任务后任务会从最近的检查点开始同步任务；当任务处于增量阶段，任务将根据 checkpoint 中的时间戳同步时间戳晚于最后一次操作的时间戳的对象，执行完成后进入增量逻辑


[返回目录](#index)

<a id="Troubleshooting"></a>
## 错误处理

在实际迁移操作中会碰到由于环境或数据异常造成的任务意外中断情况，大致分为一下两种情况
- 网络异常
- 数据异常

### 网络异常
- 网络中断引起的异常
  将任务描述文件中 start_from_checkpoint 设置为 true，重新启动任务即可
  ```
  attributes:
    start_from_checkpoint: true 
  ```
- 由于并发过高引起的服务端超时
  可降低任务中的并发参数并将 start_from_checkpoint 设置为 true，重新启动，相关参数示例如下
  ```
  attributes:
    start_from_checkpoint: true
    objects_per_batch: 64
    task_parallelism: 2
    start_from_checkpoint: true
    large_file_size: 128m
    multi_part_chunk: 32m
    multi_part_max_parallelism: 4
  ```

### 数据异常
数据异常通常是由于不同对象存储对于 key 的校验规则不一致导致。例如某些对象存储支持类似"a//b///c"这种 key 类型而 target 端将其视为错误路径。
处理办法：
- 保证任务正常进行
  进入 meta_dir 目录，参考配置文件中的设置
  ```
  attributes:
    meta_dir: /tmp/meta_dir/xxxx
  ```
  目录中 list_files 目录中记录所有要迁移的 key。通常，在报错信息中会给出 key 的名字以及所在文件的行号，对照该信息备份该记录后从列表文件中删除该条记录，将  start_from_checkpoint: true，重新启动任务，保证任务正常进行。

- 数据补传
  可将格式有问题的对象通过 [mc](https://github.com/minio/mc) 命令将对象下载到本地，在使用正确的路径上传至目标

  [返回目录](#index)
